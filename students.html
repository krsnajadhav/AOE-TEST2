<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AOE School - Students & Fees</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f7fafc; color:#333; }
  .container { max-width:900px; margin:30px auto; padding:0 10px; }
  h1,h3 { color:#1761a0; text-align:center; }
  table { width:100%; border-collapse:collapse; margin-top:15px; }
  th,td { border:1px solid #bbb; padding:8px; text-align:left; }
  th { background:#e3e7ee; }
  input,select,textarea { width:100%; padding:8px; margin-bottom:10px; }
  button { background:#1761a0; color:white; border:none; padding:8px 15px; cursor:pointer; border-radius:4px; }
  button:hover { background:#114b7a; }
  .form-box { background:white; padding:20px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-top:20px; }
  .actions button { margin-right:5px; }
  #invoiceModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:1000; }
  #invoiceModal .modal-content { background:white; padding:20px; border-radius:10px; max-width:600px; width:90%; max-height:80%; overflow-y:auto; }
  #invoiceModal h3 { margin-top:0; }
  #invoiceModal table { width:100%; margin-top:10px; }
  #invoiceModal th { background:#e3e7ee; }
  #invoiceModal button.closeBtn { background:#d33; float:right; }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.47.1/dist/umd/supabase.min.js"></script>
</head>
<body>

<div id="headerContainer"></div>

<div class="container">
  <h1>Student Management & Fee Tracker</h1>

  <!-- Student Form -->
  <div class="form-box">
    <h3>Add / Edit Student</h3>
    <form id="studentForm">
      <input type="hidden" id="editIndex">
      <label>Student Name</label>
      <input type="text" id="studentName" required>
      <label>Parent's Mobile</label>
      <input type="text" id="parentMobile" required>
      <label>Class</label>
      <select id="studentClass" required>
        <option value="">Select Class</option>
        <option>1st</option><option>2nd</option><option>3rd</option><option>4th</option>
        <option>5th</option><option>6th</option><option>7th</option><option>8th</option>
        <option>9th</option><option>10th</option>
      </select>
      <label>Subjects</label>
      <select id="studentSubjects" required>
        <option value="">Select Subject</option>
        <option>Spoken English</option>
        <option>English</option>
        <option>Science</option>
        <option>All</option>
        <option>ES (English & Science)</option>
      </select>
      <label>Address</label>
      <textarea id="studentAddress" required></textarea>
      <label>Total Fees (₹)</label>
      <input type="number" id="studentTotalFees" placeholder="Enter total fees for this student" required>
      <button type="submit">Save Student</button>
    </form>
  </div>

  <!-- Students Table -->
  <h3>All Students & Fee Status</h3>
  <table id="studentsTable">
    <thead>
      <tr>
        <th>#</th>
        <th>Name</th>
        <th>Class</th>
        <th>Subjects</th>
        <th>Parent Mobile</th>
        <th>Total Fees (₹)</th>
        <th>Paid (₹)</th>
        <th>Remaining (₹)</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Invoice Modal -->
<div id="invoiceModal">
  <div class="modal-content">
    <button class="closeBtn" onclick="closeModal()">Close</button>
    <h3>Invoices for <span id="modalStudentName"></span></h3>
    <table id="modalInvoicesTable">
      <thead>
        <tr>
          <th>Invoice No</th>
          <th>Date</th>
          <th>Description</th>
          <th>Amount (₹)</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <p><strong>Total Paid: ₹<span id="modalTotalPaid">0</span></strong></p>
    <p><strong>Remaining Fees: ₹<span id="modalRemaining">0</span></strong></p>
    <button onclick="printFeeStatement()" style="margin-top:10px;">Print Fee Statement</button>
  </div>
</div>

<script>
fetch('header.html')
  .then(resp => resp.text())
  .then(data => { document.getElementById('headerContainer').innerHTML = data; });

// Initialize Supabase
const SUPABASE_URL = "https://xdelxrxkskvajnmowovf.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhkZWx4cnhrc2t2YWpubW93b3ZmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxOTQ2NzcsImV4cCI6MjA3NTc3MDY3N30.rwOuTyCHoKUnoaA8eOg7vRSkgbl3HDEbOqB9_6i9_Jc";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

const form = document.getElementById('studentForm');
const tableBody = document.querySelector('#studentsTable tbody');
let students = [];
let invoices = [];

// Load data from Supabase
async function loadData() {
  try {
    const { data: studentData } = await supabase.from('students').select('*').order('id', { ascending: true });
    const { data: invoiceData } = await supabase.from('invoices').select('*').order('date', { ascending: false });
    students = studentData || [];
    invoices = invoiceData || [];
    renderStudents();
    checkHashForEdit();
  } catch(err){
    console.error('Supabase loadData error:', err);
  }
}

// Render students table
function renderStudents() {
  tableBody.innerHTML = students.length
    ? students.map((s,i) => {
        const paidAmount = invoices.filter(inv => inv.studentid===s.id)
          .reduce((sum,inv)=>sum+(inv.totalamount || (inv.items ? inv.items.reduce((s,i)=>s+i.amt,0) : 0)),0);
        const remaining = (s.totalfees||0) - paidAmount;
        return `
          <tr>
            <td>${i+1}</td>
            <td>${s.name}</td>
            <td>${s.classval}</td>
            <td>${s.subjects}</td>
            <td>${s.mobile}</td>
            <td>₹${s.totalfees||0}</td>
            <td>₹${paidAmount}</td>
            <td>₹${remaining}</td>
            <td class="actions">
              <button onclick="editStudent(${s.id})">Edit</button>
              <button onclick="deleteStudent(${s.id})" style="background:#d33;">Delete</button>
              <button onclick="viewInvoices(${s.id},'${s.name}')">View Invoices</button>
            </td>
          </tr>`;
      }).join('')
    : `<tr><td colspan="9" style="text-align:center;">No students added yet.</td></tr>`;
}

// Add / Edit student
form.onsubmit = async e => {
  e.preventDefault();
  const name = document.getElementById('studentName').value.trim();
  const mobile = document.getElementById('parentMobile').value.trim();
  const classVal = document.getElementById('studentClass').value;
  const subjects = document.getElementById('studentSubjects').value;
  const address = document.getElementById('studentAddress').value.trim();
  const totalFees = parseInt(document.getElementById('studentTotalFees').value.trim())||0;
  if (totalFees < 0) {
    alert('Fees cannot be negative.');
    return;
  }
  const editIndex = document.getElementById('editIndex').value;
  const student = { name, mobile, classval: classVal, subjects, address, totalfees: totalFees };
  try {
    if(editIndex){
      await supabase.from('students').update(student).eq('id', Number(editIndex));
    } else {
      await supabase.from('students').insert([student]);
    }
    form.reset();
    document.getElementById('editIndex').value = '';
    await loadData();
  } catch(err){ console.error('Supabase form submit error:', err); }
};

// Edit student
async function editStudent(id){
  try {
    const { data } = await supabase.from('students').select('*').eq('id', id).single();
    if(data){
      document.getElementById('studentName').value=data.name;
      document.getElementById('parentMobile').value=data.mobile;
      document.getElementById('studentClass').value=data.classval;
      document.getElementById('studentSubjects').value=data.subjects;
      document.getElementById('studentAddress').value=data.address;
      document.getElementById('studentTotalFees').value=data.totalfees||0;
      document.getElementById('editIndex').value=data.id;
      window.scrollTo(0,0);
    }
  } catch(err){ console.error('Edit student fetch error:', err); }
}

// Delete student
async function deleteStudent(id){
  if(confirm('Delete this student?')){
    try { await supabase.from('students').delete().eq('id', id); await loadData(); }
    catch(err){ console.error('Delete student error:', err); }
  }
}

// View invoices
async function viewInvoices(studentId, studentName){
  document.getElementById('modalStudentName').textContent = studentName;
  const tbody = document.querySelector('#modalInvoicesTable tbody');
  const studentInvoices = invoices.filter(inv=>inv.studentid===studentId);
  let totalPaid = 0;
  if(studentInvoices.length===0){
    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;">No invoices found.</td></tr>`;
  } else {
    tbody.innerHTML = studentInvoices.map(inv=>{
      const totalAmount = inv.totalamount || (inv.items ? inv.items.reduce((sum,i)=>sum+i.amt,0) : 0);
      totalPaid += totalAmount;
      const itemDesc = inv.items ? inv.items.map((i, idx) => `${idx+1}. ${i.desc} (₹${i.amt})`).join(', ') : (inv.subject || 'N/A');
      return `<tr>
        <td>${inv.invoiceno}</td>
        <td>${new Date(inv.date).toLocaleDateString()}</td>
        <td>${itemDesc}</td>
        <td>₹${totalAmount}</td>
      </tr>`;
    }).join('');
  }
  const student = students.find(s=>s.id===studentId);
  const remaining = (student?.totalfees||0) - totalPaid;
  document.getElementById('modalTotalPaid').textContent = totalPaid;
  document.getElementById('modalRemaining').textContent = remaining;
  document.getElementById('invoiceModal').style.display='flex';
}

function closeModal(){ document.getElementById('invoiceModal').style.display='none'; }
function printFeeStatement(){
  const modalContent = document.querySelector('#invoiceModal .modal-content');
  const modalClone = modalContent.cloneNode(true);
  const closeBtn = modalClone.querySelector('.closeBtn');
  if (closeBtn) closeBtn.remove();
  const printContent = modalClone.innerHTML;
  const printWindow = window.open('', '', 'height=600,width=800');
  printWindow.document.write('<html><head><title>Fee Statement</title>');
  printWindow.document.write('<style>body{font-family:Arial,sans-serif;} table{width:100%;border-collapse:collapse;margin-top:10px;} th,td{border:1px solid #bbb;padding:8px;text-align:left;} th{background:#e3e7ee;}</style>');
  printWindow.document.write('</head><body>');
  printWindow.document.write(printContent);
  printWindow.document.write('</body></html>');
  printWindow.document.close();
  printWindow.focus();
  printWindow.print();
}

// Check URL hash for edit
function checkHashForEdit(){
  const hash = window.location.hash;
  if(hash.startsWith('#edit-')){
    const idStr = hash.replace('#edit-','');
    const id = parseInt(idStr);
    if (!isNaN(id)) {
      editStudent(id);
    }
  }
}

// Initial load
loadData();
</script>
</body>
</html>
